@{
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "").ToLower();
    var mode = (Context.Request?.Query["mode"].ToString() ?? "").ToLower();

    Func<string, string> active = c => ctrl == c.ToLower() ? "active" : "";

    // Flashcards group status
    bool isFlashcards = ctrl == "flashcards";
    bool openFlashcards = isFlashcards;
    string fcCollapseClass = openFlashcards ? "show" : "";
    string fcAriaExpanded = openFlashcards ? "true" : "false";
    string FcItemActive(string m) => (isFlashcards && mode == m) ? "active" : "";

    // Games group status (open when in Games or Exams)
    bool isGames = ctrl == "games" || ctrl == "exams";
    string gamesCollapseClass = isGames ? "show" : "";
    string gamesAriaExpanded = isGames ? "true" : "false";
}

<!-- Sidebar (được điều khiển bởi nút ☰ có id="btnSidebar") -->
<aside id="appSidebar"
       class="app-sidebar bg-body border-end"
       role="navigation"
       aria-label="Main menu">

    <div class="p-3 pb-2 d-flex align-items-center gap-2 border-bottom">
        <i class="bi bi-grid text-primary"></i>
        <span class="fw-semibold">Menu</span>
    </div>

    <nav class="nav flex-column py-2">
        <!-- Translate -->
        <a class="nav-link @active("Translate")"
           asp-controller="Translate" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-translate me-2"></i> Translate
        </a>

        <!-- Conversation -->
        <a class="nav-link @active("Chat")"
           asp-controller="Chat" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-chat-dots me-2"></i> Conversation
        </a>

        <!-- Dictation -->
        <a class="nav-link @active("Dictation")"
           asp-controller="Dictation" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-pencil-square me-2"></i> Dictation
        </a>

        <!-- Pronunciation -->
        <a class="nav-link @active("Pronunciation")"
           asp-controller="Pronunciation" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-mic me-2"></i> Pronunciation
        </a>

        <!-- Placement test / Test trình độ -->
        <a class="nav-link @active("PlacementTest")"
           asp-controller="PlacementTest" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-graph-up-arrow me-2"></i> Placement test
            @* hoặc: <span>Test trình độ</span> *@
        </a>

        <!-- Flashcards group -->
        <a class="nav-link d-flex align-items-center @(isFlashcards ? "active" : "")"
           data-bs-toggle="collapse"
           href="#flashcardsMenu"
           role="button"
           aria-expanded="@fcAriaExpanded"
           aria-controls="flashcardsMenu">
            <i class="bi bi-collection me-2"></i>
            <span class="flex-grow-1">Flashcards</span>
            <i class="bi bi-caret-down ms-auto"></i>
        </a>
        <div class="collapse @fcCollapseClass" id="flashcardsMenu">
            <div class="nav flex-column ms-4 my-1">
                <a class="nav-link small @FcItemActive("basic")"
                   asp-controller="Flashcards" asp-action="Index" asp-route-mode="basic" data-hard-nav="true">
                    Common English
                </a>
                <a class="nav-link small @FcItemActive("ielts")"
                   asp-controller="Flashcards" asp-action="Index" asp-route-mode="ielts" data-hard-nav="true">
                    IELTS Vocabulary
                </a>
                <a class="nav-link small @FcItemActive("hsk")"
                   asp-controller="Flashcards" asp-action="Index" asp-route-mode="hsk" data-hard-nav="true">
                    HSK Chinese
                </a>
            </div>
        </div>

        <!-- Games group -->
        <a class="nav-link d-flex align-items-center @(isGames ? "active" : "")"
           data-bs-toggle="collapse"
           href="#gamesMenu"
           role="button"
           aria-expanded="@gamesAriaExpanded"
           aria-controls="gamesMenu">
            <i class="bi bi-joystick me-2"></i>
            <span class="flex-grow-1">Games</span>
            <i class="bi bi-caret-down ms-auto"></i>
        </a>
        <div class="collapse @gamesCollapseClass" id="gamesMenu">
            <div class="nav flex-column ms-4 my-1">
                <a class="nav-link small @(ctrl=="exams" ? "active" : "")"
                   asp-controller="Exams" asp-action="Index" data-hard-nav="true">
                    <i class="bi bi-trophy me-1"></i> Thi (Bảng & xếp hạng)
                </a>

                <a class="nav-link small @(ctrl=="games" && !Context.Request.Path.Value!.Contains("/play/") ? "active" : "")"
                   asp-controller="Games" asp-action="Index" data-hard-nav="true">
                    Danh sách Level
                </a>
            </div>
        </div>

        <!-- Courses -->
        <a class="nav-link @active("Courses")"
           asp-controller="Courses" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-mortarboard me-2"></i> Courses
        </a>

        <!-- Settings -->
        <a class="nav-link @active("Settings")"
           asp-controller="Settings" asp-action="Index" data-hard-nav="true">
            <i class="bi bi-gear me-2"></i> Settings
        </a>
    </nav>
</aside>
